<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping game</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
          --primary: #232f3e;
          --accent: #f3a847;
          --success: #27ae60;
          --danger: #c0392b;
          --bg: #eaeded;
        }

        * { box-sizing: border-box; }

        body {
          background-color: var(--bg);
          font-family: 'Poppins', sans-serif;
          margin: 0;
          display: flex;
          flex-direction: column;
          align-items: center;
          min-height: 100vh;
        }

        /* --- UI STYLES --- */
        header {
            background-color: var(--primary);
            color: white;
            width: 100%;
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .status-bar {
            background: white;
            width: 95%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-bottom: 4px solid var(--accent);
        }

        .balance-group div { font-size: 2rem; font-weight: 800; color: var(--success); }

        .play-btn {
            background-color: var(--primary);
            color: white;
            border: 2px solid var(--accent);
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            text-transform: uppercase;
            box-shadow: 0 5px 0 #111;
            transition: transform 0.1s;
        }
        .play-btn:active { transform: translateY(4px); box-shadow: none; }

        .container {
            width: 95%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 50px;
        }

        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }

        section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        h3 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }

        .mission-header { display: flex; justify-content: space-between; align-items: center; }
        .reroll-btn { background: #555; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        #mission-list { list-style: none; padding: 0; display: flex; flex-wrap: wrap; gap: 10px; }
        .mission-item { background: #f9f9f9; border: 1px solid #ddd; padding: 8px 12px; border-radius: 20px; font-size: 0.9rem; }
        .mission-item.done { background: var(--success); color: white; border-color: var(--success); }

        .store-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .product-card { border: 1px solid #eee; padding: 10px; text-align: center; border-radius: 8px; transition: 0.2s; display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        .product-card.upgrade { border: 2px solid #8e44ad; background: #f4ecf7; } 
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--accent); }
        .buy-btn { background: var(--accent); border: none; padding: 8px; width: 100%; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        
        .badge { position: absolute; top: 5px; right: 5px; background: #8e44ad; color: white; font-size: 0.6rem; padding: 2px 5px; border-radius: 3px; }

        .inventory-list, .history-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; }
        .inventory-list li, .history-list li { border-bottom: 1px solid #eee; padding: 8px 0; display: flex; justify-content: space-between; font-size: 0.85rem; }
        .history-list li.plus { border-left: 3px solid var(--success); padding-left: 5px; }
        .history-list li.minus { border-left: 3px solid var(--danger); padding-left: 5px; }

        /* --- GAME MODAL --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .game-container {
            position: relative;
            background: #000;
            padding: 10px;
            border: 4px solid #444;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.2);
            text-align: center;
        }

        canvas { background: #000; border: 2px solid #333; display: block; }
        .game-ui { color: #fff; font-family: 'Press Start 2P', cursive; margin-bottom: 10px; display: flex; justify-content: space-between; font-size: 0.6rem; }
        .controls-hint { color: #888; font-size: 0.8rem; margin-top: 10px; font-family: monospace; }
        #game-over-screen { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-family: 'Press Start 2P', cursive; text-align: center; display: none; }

        .popup-text { position: absolute; color: #00ff00; font-weight: bold; font-family: 'Press Start 2P'; font-size: 1rem; pointer-events: none; animation: floatUp 1s forwards; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

    </style>
</head>
<body>

    <header><h1>Shopping game</h1></header>

    <div class="status-bar">
        <div class="balance-group"><small>Current Wallet</small><div id="balance">¬•0</div></div>
        <button class="play-btn" onclick="openGame()">üéÆ PLAY</button>
    </div>

    <div class="container">
        <div class="main-area">
            <section>
                <div class="mission-header"><h3>üìú Mission List</h3><button class="reroll-btn" onclick="rerollMission()">üîÑ Reroll</button></div>
                <ul id="mission-list"></ul>
                <h2 id="win-msg" style="display:none; color:var(--success); text-align:center;">üéâ MISSION COMPLETE! üéâ</h2>
            </section>
            <section><h3>üõçÔ∏è Amazon Store</h3><div class="store-grid" id="store-grid"></div></section>
        </div>
        <div class="side-area">
            <section><h3>üéí Inventory</h3><ul class="inventory-list" id="inventory-list"></ul></section>
            <section><h3>üí≥ Data Logs</h3><ul class="history-list" id="history-list"></ul><button onclick="clearData()" style="width:100%; padding:5px; background:#ddd; border:none; margin-top:10px; cursor:pointer;">Reset System</button></section>
        </div>
    </div>

    <div id="game-modal" class="modal-overlay">
        <div class="game-container">
            <div class="game-ui">
                <span>KILLS: <span id="kills-display">0</span> | SCORE: <span id="score-display">0</span></span>
                <span>STATUS: <span id="status-display" style="color:#0f0;">NORMAL</span></span>
            </div>
            <canvas id="gameCanvas" width="600" height="400"></canvas>
            <div id="game-over-screen">
                <h2 style="color:red">GAME OVER</h2>
                <p>EARNINGS: ¬•<span id="final-score">0</span></p>
                <button onclick="closeGame()" style="padding:10px; cursor:pointer;">COLLECT & EXIT</button>
            </div>
            <div class="controls-hint">ARROWS: Move ‚Ä¢ SPACE: Bullets ‚Ä¢ <b style="color:#ff00ff">V: LASER</b></div>
        </div>
    </div>

    <script>
        // --- SHOPPING LOGIC ---
        const products = [
            // UPGRADES
            { id: 21, name: "Speed Chip", price: 5000, icon: "‚ö°", type: "upgrade", unlock: "SPEED" },
            { id: 22, name: "Rapid Fire Mod", price: 15000, icon: "üî•", type: "upgrade", unlock: "RAPID" },
            { id: 23, name: "Shield Generator", price: 30000, icon: "üõ°Ô∏è", type: "upgrade", unlock: "SHIELD" },
            { id: 24, name: "Double Cannon", price: 50000, icon: "‚úåÔ∏è", type: "upgrade", unlock: "DOUBLE" },
            { id: 26, name: "Triple Cannon", price: 80000, icon: "üî±", type: "upgrade", unlock: "WIDE" },
            { id: 27, name: "Magnet ", price: 100000, icon: "üß≤", type: "upgrade", unlock: "MAGNET" },
            { id: 28, name: "Opt", price: 150000, icon: "üõ∏", type: "upgrade", unlock: "OPTION" },
            { id: 29, name: "Gold Rush", price: 200000, icon: "üí∞", type: "upgrade", unlock: "GOLD" },
            { id: 30, name: "Laser", price: 300000, icon: "üî´", type: "upgrade", unlock: "LASER" },
            { id: 31, name: "Bomb", price: 500000, icon: "üí£", type: "upgrade", unlock: "BOMB" },

            // REGULAR ITEMS
            { id: 1, name: "Apple", price: 100, icon: "üçé" },
            { id: 2, name: "Coffee", price: 400, icon: "‚òï" },
            { id: 3, name: "Book", price: 1200, icon: "üìö" },
            { id: 4, name: "T-Shirt", price: 2500, icon: "üëï" },
            { id: 5, name: "Headphones", price: 8000, icon: "üéß" },
            { id: 6, name: "Sneakers", price: 12000, icon: "üëü" },
            { id: 7, name: "Smartphone", price: 80000, icon: "üì±" },
            { id: 8, name: "Laptop", price: 150000, icon: "üíª" },
            { id: 9, name: "Diamond", price: 500000, icon: "üíé" },
            { id: 10, name: "Crown", price: 9999999, icon: "üëë" },
            { id: 11, name: "Gaming Console", price: 6000000, icon: "üéÆ" },
            { id: 12, name: "Bicycle", price: 3000000, icon: "üö≤" },
            { id: 13, name: "Watch", price: 4500000, icon: "‚åö" },
            { id: 14, name: "TV", price: 2500000, icon: "üì∫" },
            { id: 15, name: "Backpack", price: 20000, icon: "üéí" },
            { id: 16, name: "Camera", price: 70000, icon: "üì∑" },
            { id: 17, name: "Guitar", price: 55000, icon: "üé∏" },
            { id: 18, name: "house" , price: 30000000, icon: "üè†" },
            { id: 19, name: "Villa", price: 90000000000, icon: "üèòÔ∏è" },
            { id: 20, name: "Spaceship", price: 100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000, icon: "üöÄ" } 
        ];

        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        let mission = JSON.parse(localStorage.getItem('mission')) || [];

        function init() { 
            fixLegacyData(); // Auto-fix old save data
            if(mission.length === 0) rerollMission(); 
            renderStore(); 
            updateUI(); 
        }

        // --- NEW: FIX OLD SAVE DATA ---
        function fixLegacyData() {
            let fixed = false;
            inventory = inventory.map(item => {
                // Find current product definition by ID
                const currentDef = products.find(p => p.id === item.id);
                if (currentDef && currentDef.type === 'upgrade' && !item.unlock) {
                    // Update old item with new properties
                    fixed = true;
                    return currentDef; 
                }
                return item;
            });
            if(fixed) {
                localStorage.setItem('inventory', JSON.stringify(inventory));
                console.log("Legacy data updated!");
            }
        }

        function updateUI() {
            const total = transactions.reduce((acc, t) => acc + t.amount, 0);
            document.getElementById('balance').innerText = `¬•${total.toLocaleString()}`;
            const historyEl = document.getElementById('history-list'); historyEl.innerHTML = '';
            transactions.slice().reverse().slice(0, 8).forEach(t => {
                const li = document.createElement('li'); li.className = t.amount > 0 ? 'plus' : 'minus';
                li.innerHTML = `<span>${t.text}</span><span>${t.amount > 0 ? '+' : ''}¬•${t.amount.toLocaleString()}</span>`;
                historyEl.appendChild(li);
            });
            const inventoryEl = document.getElementById('inventory-list'); inventoryEl.innerHTML = '';
            inventory.slice().reverse().forEach(item => {
                const li = document.createElement('li'); li.innerHTML = `<span>${item.icon} ${item.name}</span> <small>Owned</small>`;
                inventoryEl.appendChild(li);
            });
            renderMission();
        }

        function addTransaction(text, amount) { transactions.push({ text, amount, id: Date.now() }); localStorage.setItem('transactions', JSON.stringify(transactions)); updateUI(); }
        
        function renderStore() {
            const storeEl = document.getElementById('store-grid'); storeEl.innerHTML = '';
            products.forEach(p => {
                const div = document.createElement('div'); 
                div.className = p.type === 'upgrade' ? 'product-card upgrade' : 'product-card';
                let extraHtml = p.type === 'upgrade' ? `<div class="badge">UPGRADE</div>` : '';
                div.innerHTML = `${extraHtml}<div style="font-size:2rem">${p.icon}</div><strong>${p.name}</strong><div style="color:#b12704">¬•${p.price.toLocaleString()}</div><button class="buy-btn" onclick="buyItem(${p.id})">Buy</button>`;
                storeEl.appendChild(div);
            });
        }

        function buyItem(id) {
            const p = products.find(i => i.id === id);
            
            if(p.type === 'upgrade' && inventory.some(i => i.id === id)) {
                alert("‚ö† You already bought this upgrade!");
                return;
            }

            const balance = transactions.reduce((acc, t) => acc + t.amount, 0);
            if(balance < p.price) { alert("‚ùå INSUFFICIENT FUNDS."); return; }
            addTransaction(`Bought ${p.name}`, -p.price); inventory.push(p);
            localStorage.setItem('inventory', JSON.stringify(inventory)); updateUI();
            
            if(p.type === 'upgrade') {
                alert(`‚úÖ UPGRADE UNLOCKED: ${p.unlock}!\nIt will now drop in the shooting game.`);
            } else if(mission.includes(p.name)) {
                alert(`üéâ MISSION ITEM ACQUIRED: ${p.name}!\nCheck your mission list.`);
            } else if(p.name === "Spaceship") { 
                alert("üöÄ YOU WON THE GAME!"); localStorage.clear(); location.reload(); 
            }
        }

        function rerollMission() {
            const pool = products.filter(p => p.type !== 'upgrade' && p.name !== "Spaceship");
            mission = pool.sort(() => 0.5 - Math.random()).slice(0, 3).map(p => p.name);
            localStorage.setItem('mission', JSON.stringify(mission)); updateUI();
        }

        function renderMission() {
            const missionEl = document.getElementById('mission-list'); missionEl.innerHTML = ''; let count = 0;
            mission.forEach(name => {
                const owned = inventory.some(i => i.name === name);
                const li = document.createElement('li'); li.className = owned ? 'mission-item done' : 'mission-item';
                li.innerText = owned ? `‚úÖ ${name}` : `‚¨ú ${name}`; if(owned) count++; missionEl.appendChild(li);
            });
            document.getElementById('win-msg').style.display = count === mission.length ? 'block' : 'none';
        }

        function clearData() { if(confirm("Reset?")) { localStorage.clear(); location.reload(); } }

        /* -----------------------------------------------------
           PART 2: GAME LOGIC 
           ----------------------------------------------------- */
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const modal = document.getElementById('game-modal');
        const scoreDisplay = document.getElementById('score-display');
        const killsDisplay = document.getElementById('kills-display');
        const statusDisplay = document.getElementById('status-display');
        const gameOverScreen = document.getElementById('game-over-screen');
        const finalScoreSpan = document.getElementById('final-score');

        let gameRunning = false;
        let score = 0;
        let kills = 0;
        let animationId;
        const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, " ": false, "v": false };

        document.addEventListener('keydown', (e) => { 
            const key = e.key.toLowerCase() === 'v' ? 'v' : e.key;
            if(keys.hasOwnProperty(key)) { keys[key] = true; if(modal.style.display === 'flex') e.preventDefault(); }
        });
        document.addEventListener('keyup', (e) => { 
            const key = e.key.toLowerCase() === 'v' ? 'v' : e.key;
            if(keys.hasOwnProperty(key)) keys[key] = false; 
        });

        const player = { 
            x: 50, y: 200, width: 30, height: 20, speed: 4, 
            cooldown: 0, cooldownMax: 15, powerType: 'NORMAL', 
            hasLaser: false, laserCooldown: 0, shield: false,
            hasBack: false, hasOption: false, hasMagnet: false, goldRush: 0
        };
        
        let bullets = []; let enemies = []; let powerups = []; let stars = []; 

        function openGame() {
            if(gameRunning) return;
            document.activeElement.blur();
            modal.style.display = 'flex'; gameOverScreen.style.display = 'none';
            score = 0; kills = 0; scoreDisplay.innerText = "0"; killsDisplay.innerText = "0"; statusDisplay.innerText = "NORMAL";
            
            // Reset Player
            player.x = 50; player.y = 200; player.speed = 4; 
            player.powerType = 'NORMAL'; player.hasLaser = false; player.shield = false; player.cooldownMax = 15;
            player.hasBack = false; player.hasOption = false; player.hasMagnet = false; player.goldRush = 0;
            
            bullets = []; enemies = []; powerups = []; stars = [];
            for(let i=0; i<50; i++) stars.push({ x: Math.random()*600, y: Math.random()*400, speed: Math.random()*3+1 });
            
            gameRunning = true; loop();
        }

        function closeGame() {
            modal.style.display = 'none'; gameRunning = false; cancelAnimationFrame(animationId);
            if(score > 0) addTransaction("Pilot Wages", score);
        }

        function spawnEnemy() {
            if(Math.random() < 0.02 + (kills * 0.0001)) { 
                let type = 'red'; let hp = 1; let speed = 2 + Math.random(); let color = '#e74c3c'; let value = 300;
                if (kills >= 30) { type = 'yellow'; hp = 3; speed = 4; color = '#f1c40f'; value = 600; } 
                if (kills >= 60) { type = 'blue'; hp = 5; speed = 6; color = '#3498db'; value = 1000; } 
                if (kills >= 90) { type = 'purple'; hp = 8; speed = 8; color = '#9b59b6'; value = 2000; }
                if(Math.random() < 0.05) { type = 'gold'; hp = 5; speed = 9; color = '#fff'; value = 5000; }
                enemies.push({ x: canvas.width, y: Math.random() * (canvas.height - 30), width: 30, height: 30, speed: speed, type: type, color: color, value: value, hp: hp });
            }
        }

        function spawnPowerUp(x, y) {
            // Drop powerups based on what user has BOUGHT
            let availableUpgrades = [];
            inventory.forEach(item => {
                // Check if it's an upgrade and has an unlock code
                if(item.type === 'upgrade' && item.unlock) {
                    availableUpgrades.push(item.unlock);
                }
            });

            if(availableUpgrades.length === 0) return; // No upgrades bought = no drops

            const type = availableUpgrades[Math.floor(Math.random() * availableUpgrades.length)];
            powerups.push({ x: x, y: y, width: 20, height: 20, type: type });
        }

        function showFloatingText(text, x, y, color='#00ff00') {
            const div = document.createElement('div'); div.className = 'popup-text'; div.innerText = text;
            div.style.left = canvas.getBoundingClientRect().left + x + 'px'; div.style.top = canvas.getBoundingClientRect().top + y + 'px';
            div.style.color = color;
            document.body.appendChild(div); setTimeout(() => div.remove(), 1000);
        }

        function update() {
            if(!gameRunning) return;

            // Player Move
            if(keys.ArrowUp && player.y > 0) player.y -= player.speed;
            if(keys.ArrowDown && player.y < 400 - player.height) player.y += player.speed;
            if(keys.ArrowLeft && player.x > 0) player.x -= player.speed;
            if(keys.ArrowRight && player.x < 600 - player.width) player.x += player.speed;
            if(player.goldRush > 0) player.goldRush--;

            // --- SHOOTING (SPACEBAR: Normal/Double/Wide) ---
            if(keys[" "] && player.cooldown <= 0) {
                
                // 1. Determine Firing Positions (Main + Options)
                // 0 = Main Ship, -30 = Top Option, +30 = Bottom Option
                let fireOffsets = [0];
                if (player.hasOption) {
                    fireOffsets.push(-30); 
                    fireOffsets.push(30); 
                }

                // 2. Fire weapons for EVERY position
                fireOffsets.forEach(offset => {
                    let fireY = player.y + offset; // Calculate Y position

                    // Primary Weapon Logic
                    if(player.powerType === 'DOUBLE') {
                        bullets.push({ x: player.x+30, y: fireY, speed: 10, dy: -2, type: 'normal' });
                        bullets.push({ x: player.x+30, y: fireY+20, speed: 10, dy: 2, type: 'normal' });
                    } else if(player.powerType === 'WIDE') {
                        bullets.push({ x: player.x+30, y: fireY+10, speed: 10, dy: 0, type: 'normal' });
                        bullets.push({ x: player.x+30, y: fireY+10, speed: 10, dy: -3, type: 'normal' });
                        bullets.push({ x: player.x+30, y: fireY+10, speed: 10, dy: 3, type: 'normal' });
                    } else {
                        bullets.push({ x: player.x+30, y: fireY+10, speed: 10, dy: 0, type: 'normal' });
                    }

                    // Back Fire Logic (Tripled too!)
                    if(player.hasBack) {
                        bullets.push({ x: player.x, y: fireY+10, speed: -5, dy: 0, type: 'normal', isBack: true });
                    }
                });

                player.cooldown = player.cooldownMax;
            }
            if(player.cooldown > 0) player.cooldown--;

            // --- SHOOTING (V: LASER - Now Tripled!) ---
            if(keys["v"] && player.hasLaser && player.laserCooldown <= 0) {
                let fireOffsets = [0];
                if (player.hasOption) fireOffsets.push(-30, 30);

                fireOffsets.forEach(offset => {
                    bullets.push({ x: player.x+30, y: player.y + offset + 5, speed: 18, dy: 0, width: 40, height: 6, type: 'laser' });
                });
                player.laserCooldown = 20; 
            }
            if(player.laserCooldown > 0) player.laserCooldown--;

            // Move Bullets
            bullets.forEach((b, i) => {
                b.x += b.speed; if(b.dy) b.y += b.dy;
                if(b.x > 600 || b.x < 0) bullets.splice(i, 1);
            });

            // Move PowerUps
            powerups.forEach((p, i) => {
                if(player.hasMagnet) { p.x += (player.x - p.x) * 0.05; p.y += (player.y - p.y) * 0.05; } else { p.x -= 2; }
                if(p.x < -20) powerups.splice(i, 1);
                bullets.forEach((b, bIndex) => {
                    if(b.x < p.x + p.width && b.x + 10 > p.x && b.y < p.y + p.height && b.y + 10 > p.y) {
                        // Apply Upgrades
                        if(p.type === 'SPEED') { player.speed = Math.min(player.speed + 2, 12); showFloatingText("SPEED UP", p.x, p.y); }
                        else if(p.type === 'DOUBLE') { player.powerType = 'DOUBLE'; showFloatingText("DOUBLE", p.x, p.y); }
                        else if(p.type === 'WIDE') { player.powerType = 'WIDE'; showFloatingText("WIDE SHOT", p.x, p.y, '#9b59b6'); }
                        else if(p.type === 'LASER') { player.hasLaser = true; showFloatingText("LASER (Press V)", p.x, p.y, '#ff00ff'); }
                        else if(p.type === 'RAPID') { player.cooldownMax = 8; showFloatingText("RAPID", p.x, p.y); }
                        else if(p.type === 'SHIELD') { player.shield = true; showFloatingText("SHIELD", p.x, p.y, '#3498db'); }
                        else if(p.type === 'BACK') { player.hasBack = true; showFloatingText("BACK FIRE", p.x, p.y, '#e67e22'); }
                        else if(p.type === 'OPTION') { player.hasOption = true; showFloatingText("DRONES ACTIVE", p.x, p.y, '#1abc9c'); }
                        else if(p.type === 'MAGNET') { player.hasMagnet = true; showFloatingText("MAGNET", p.x, p.y, '#bdc3c7'); }
                        else if(p.type === 'GOLD') { player.goldRush = 600; showFloatingText("GOLD RUSH!", p.x, p.y, '#f1c40f'); }
                        else if(p.type === 'BOMB') { enemies.forEach(e => { score += e.value; kills++; }); enemies = []; showFloatingText("BOMB!", 300, 200, '#c0392b'); scoreDisplay.innerText = score.toLocaleString(); }
                        
                        let status = player.powerType;
                        if(player.hasOption) status += " + OPT";
                        if(player.goldRush > 0) status += " + $$$";
                        statusDisplay.innerText = status;
                        powerups.splice(i, 1); bullets.splice(bIndex, 1);
                    }
                });
            });

            // Enemies
            spawnEnemy();
            enemies.forEach((e, eIndex) => {
                e.x -= e.speed;
                if (player.x < e.x + e.width && player.x + player.width > e.x && player.y < e.y + e.height && player.y + player.height > e.y) {
                    if(player.shield) { player.shield = false; showFloatingText("SHIELD LOST!", player.x, player.y, '#c0392b'); enemies.splice(eIndex, 1); }
                    else { endGame(); }
                }
                bullets.forEach((b, bIndex) => {
                    const bW = b.width || 10; const bH = b.height || 4;
                    if (b.x < e.x + e.width && b.x + bW > e.x && b.y < e.y + e.height && b.y + bH > e.y) {
                        e.hp--;
                        if(b.type !== 'laser') bullets.splice(bIndex, 1);
                        if(e.hp <= 0) {
                            score += (player.goldRush > 0 ? e.value * 2 : e.value); kills++;
                            scoreDisplay.innerText = score.toLocaleString(); killsDisplay.innerText = kills;
                            if(Math.random() < 0.3) spawnPowerUp(e.x, e.y);
                            enemies.splice(eIndex, 1);
                        }
                    }
                });
                if(e.x + 30 < 0) enemies.splice(eIndex, 1);
            });

            stars.forEach(s => { s.x -= s.speed; if(s.x < 0) s.x = 600; });
        }

        function draw() {
            ctx.fillStyle = "black"; ctx.fillRect(0, 0, 600, 400);
            ctx.fillStyle = "white"; stars.forEach(s => { ctx.beginPath(); ctx.arc(s.x, s.y, 1, 0, Math.PI*2); ctx.fill(); });

            // Player
            ctx.fillStyle = player.goldRush > 0 ? "#f1c40f" : "#3498db"; 
            ctx.beginPath(); ctx.moveTo(player.x+30, player.y+10); ctx.lineTo(player.x, player.y); ctx.lineTo(player.x+5, player.y+10); ctx.lineTo(player.x, player.y+20); ctx.fill();
            
            // Draw Option Wingmen (UPDATED POSITIONS to match firing)
            if(player.hasOption) {
                ctx.fillStyle = "#1abc9c";
                ctx.beginPath(); ctx.arc(player.x, player.y - 20, 6, 0, Math.PI*2); ctx.fill(); // Top Wing
                ctx.beginPath(); ctx.arc(player.x, player.y + 40, 6, 0, Math.PI*2); ctx.fill(); // Bottom Wing
            }

            if(player.shield) { ctx.strokeStyle = "cyan"; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(player.x+15, player.y+10, 25, 0, Math.PI*2); ctx.stroke(); }

            bullets.forEach(b => { 
                if(b.type === 'laser') ctx.fillStyle = '#ff00ff';
                else if(b.isBack) ctx.fillStyle = '#e67e22';
                else ctx.fillStyle = '#ffff00';
                ctx.fillRect(b.x, b.y, b.width||10, b.height||4); 
            });

            powerups.forEach(p => {
                let color = '#2ecc71'; 
                if(p.type === 'SHIELD') color = '#3498db'; if(p.type === 'BOMB') color = '#e74c3c';
                if(p.type === 'LASER') color = '#ff00ff'; if(p.type === 'GOLD') color = '#f1c40f';
                if(p.type === 'OPTION') color = '#1abc9c';
                ctx.fillStyle = color; ctx.fillRect(p.x, p.y, p.width, p.height);
                ctx.strokeStyle = "white"; ctx.strokeRect(p.x, p.y, p.width, p.height);
                ctx.fillStyle = "white"; ctx.font = "10px Arial"; ctx.fillText(p.type[0], p.x+5, p.y+14);
            });

            enemies.forEach(e => {
                ctx.fillStyle = e.color;
                ctx.beginPath(); ctx.moveTo(e.x, e.y); ctx.lineTo(e.x+30, e.y+15); ctx.lineTo(e.x, e.y+30); ctx.lineTo(e.x+15, e.y+15); ctx.fill();
            });
        }

        function loop() { if(!gameRunning) return; update(); draw(); animationId = requestAnimationFrame(loop); }

        function endGame() {
            gameRunning = false;
            finalScoreSpan.innerText = score.toLocaleString();
            gameOverScreen.style.display = 'block';
        }

        document.addEventListener('keydown', function(event) {
            if (event.shiftKey && (event.key === 'X' || event.key === 'x')) {
                let amount = prompt("SECRET DEV MODE ACTIVATED\nHow much money do you want?");
                let numberAmount = Number(amount);
                if (amount !== null && !isNaN(numberAmount)) {
                    addTransaction("Dev Mode", numberAmount);
                }
            }
        });

        init();
    </script>
</body>
</html>